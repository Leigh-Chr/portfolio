---
import { Image } from 'astro:assets';
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { url } from '@utils/url';
import { getLogoImage } from '@utils/images';

// Get all experiences from content collection
const allExperiences = await getCollection('experiences');

// Get projects and skills for title lookup
const allProjects = await getCollection('projects');
const allSkills = await getCollection('skills');

// Create lookup maps for slug -> title
const projectTitles = new Map(allProjects.map((p) => [p.slug, p.data.title]));
const skillTitles = new Map(allSkills.map((s) => [s.slug, s.data.title]));
const sortedExperiences = allExperiences.sort((a, b) => {
  // Sort by start date ascending (chronological: oldest first)
  return new Date(a.data.startDate).getTime() - new Date(b.data.startDate).getTime();
});

const hasRealContent = sortedExperiences.length > 0;

// Placeholder experiences if none exist (chronological: oldest first)
const placeholderExperiences = [
  {
    slug: 'exp-5',
    data: {
      type: 'education' as const,
      title: 'Licence Informatique',
      organization: 'Universit√©',
      logo: null,
      location: 'Bordeaux, France',
      startDate: '2016-09',
      endDate: '2019-06',
      current: false,
      order: 5,
      relatedProjects: [],
      relatedSkills: [],
    },
    body: 'Formation fondamentale en informatique.',
  },
  {
    slug: 'exp-3',
    data: {
      type: 'education' as const,
      title: 'Master Ing√©nierie Logicielle',
      organization: "√âcole d'Ing√©nieurs",
      logo: null,
      location: 'Paris, France',
      startDate: '2019-09',
      endDate: '2021-06',
      current: false,
      order: 3,
      relatedProjects: [],
      relatedSkills: [],
    },
    body: 'Formation en g√©nie logiciel et syst√®mes distribu√©s.',
  },
  {
    slug: 'exp-4',
    data: {
      type: 'work' as const,
      title: 'Stagiaire D√©veloppeur',
      organization: 'Agence Web',
      logo: null,
      location: 'Bordeaux, France',
      startDate: '2020-04',
      endDate: '2020-09',
      current: false,
      order: 4,
      relatedProjects: [],
      relatedSkills: [],
    },
    body: "Stage de fin d'√©tudes en d√©veloppement web.",
  },
  {
    slug: 'exp-2',
    data: {
      type: 'work' as const,
      title: 'D√©veloppeur Backend',
      organization: 'Startup Innovante',
      logo: null,
      location: 'Lyon, France',
      startDate: '2021-06',
      endDate: '2022-12',
      current: false,
      order: 2,
      relatedProjects: [],
      relatedSkills: [],
    },
    body: "D√©veloppement d'APIs et microservices.",
  },
  {
    slug: 'exp-1',
    data: {
      type: 'work' as const,
      title: 'D√©veloppeur Full Stack Senior',
      organization: 'Entreprise Tech',
      logo: null,
      location: 'Paris, France',
      startDate: '2023-01',
      endDate: null,
      current: true,
      order: 1,
      relatedProjects: [],
      relatedSkills: [],
    },
    body: 'Description du poste et des responsabilit√©s.',
  },
];

const displayExperiences = hasRealContent ? sortedExperiences : placeholderExperiences;

// Group by type
const workExperiences = displayExperiences.filter((e) => e.data.type === 'work');
const educationExperiences = displayExperiences.filter((e) => e.data.type === 'education');
const certifications = displayExperiences.filter((e) => e.data.type === 'certification');

// Format date
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
}
---

<BaseLayout
  title="Parcours"
  description="Mon parcours, des √©tudes aux exp√©riences en entreprise, dans l'ordre chronologique."
>
  <!-- Hero Section -->
  <section class="section-padding section-hero relative overflow-hidden">
    <div class="container-custom text-center" data-gsap="hero">
      <h1 class="page-title">
        Mon <span class="gradient-text-animated underline-zigzag" data-text="Parcours"
          >Parcours</span
        >
      </h1>
      <div class="section-divider section-divider-long"></div>
      <p class="page-subtitle">
        Une frise chronologique de mon √©volution professionnelle et acad√©mique, de mes premiers pas
        √† aujourd'hui.
      </p>

      <!-- Quick Stats - Bold Memphis with subtle variations -->
      <div class="flex flex-wrap justify-center gap-4 sm:gap-8 md:gap-16 mt-16">
        <div
          class="text-center p-4 sm:p-6 bg-dark-800 border-3 border-dark-600 group hover:border-accent-400 transition-all shadow-hard-lg hover:shadow-hard-xl min-w-[100px]"
        >
          <p class="stat-large text-accent-400">
            {educationExperiences.length}
          </p>
          <p
            class="text-xs sm:text-sm text-gray-400 font-heading font-medium uppercase tracking-wide mt-2"
          >
            Formations
          </p>
        </div>
        <div
          class="text-center p-4 sm:p-6 bg-dark-800 border-3 border-dark-600 group hover:border-primary-500 transition-all shadow-hard-lg hover:shadow-hard-xl min-w-[100px]"
        >
          <p class="stat-large text-primary-400">{workExperiences.length}</p>
          <p
            class="text-xs sm:text-sm text-gray-400 font-heading font-medium uppercase tracking-wide mt-2"
          >
            Exp√©riences
          </p>
        </div>
        {
          certifications.length > 0 && (
            <div class="text-center p-4 sm:p-6 bg-dark-800 border-3 border-dark-600 group hover:border-white/50 transition-all shadow-hard-lg hover:shadow-hard-xl min-w-[100px]">
              <p class="stat-large text-white">{certifications.length}</p>
              <p class="text-xs sm:text-sm text-gray-400 font-heading font-medium uppercase tracking-wide mt-2">
                Certifications
              </p>
            </div>
          )
        }
      </div>
    </div>
  </section>

  <!-- Education Section -->
  <section class="section-padding section-alt section-lazy" aria-labelledby="education-heading">
    <div class="container-custom">
      {
        !hasRealContent && (
          <div class="alert-placeholder mb-8">
            <strong>[PLACEHOLDER]</strong> Les exp√©riences ci-dessous sont des exemples.
            Remplacez-les par votre vrai parcours dans les fichiers de contenu.
          </div>
        )
      }

      <div class="max-w-4xl mx-auto">
        <!-- Education Header -->
        <div class="flex items-center gap-4 mb-12">
          <div class="icon-box-lg bg-accent-400 border-accent-400">
            <span class="text-2xl">üéì</span>
          </div>
          <h2 id="education-heading" class="text-2xl md:text-3xl font-heading font-bold text-white">
            <span class="text-accent-400">Formation</span> Acad√©mique
          </h2>
        </div>

        <!-- Education Timeline -->
        <div class="relative">
          <!-- Vertical line -->
          <div
            class="absolute left-8 md:left-8 top-0 bottom-0 w-1 bg-gradient-to-b from-accent-400/30 to-accent-400 origin-top"
            data-gsap="timeline-line"
          >
          </div>

          <!-- Start point -->
          <div class="relative flex items-start mb-12" data-gsap="reveal">
            <div class="absolute left-8 transform -translate-x-1/2">
              <div class="icon-box-lg bg-accent-400 border-accent-400">
                <span class="text-2xl">üöÄ</span>
              </div>
            </div>
            <div class="ml-20 sm:ml-24">
              <p class="text-gray-400 text-sm font-heading italic">Le d√©but de l'aventure...</p>
            </div>
          </div>

          <!-- Education Timeline items -->
          {
            educationExperiences.map((exp) => {
              return (
                <div class="relative flex items-start mb-12 last:mb-0" data-gsap="timeline-item">
                  {/* Timeline dot */}
                  <div class="absolute left-8 transform -translate-x-1/2 z-10">
                    <div
                      class={`timeline-dot-lg ${exp.data.current ? 'bg-accent-400 border-accent-400 text-dark-900' : 'bg-dark-800 border-accent-400'}`}
                    >
                      <span class="text-xl">üéì</span>
                    </div>
                  </div>

                  {/* Content card */}
                  <div class="ml-20 sm:ml-24 flex-1">
                    <div class="card-glow p-4 sm:p-6 md:p-8">
                      {/* Date badge */}
                      <div class="flex mb-3">
                        <span class="tag-accent">
                          <time datetime={exp.data.startDate}>
                            {formatDate(exp.data.startDate)}
                          </time>
                          {exp.data.current ? (
                            ' - Pr√©sent'
                          ) : exp.data.endDate ? (
                            <Fragment>
                              {' '}
                              -{' '}
                              <time datetime={exp.data.endDate}>
                                {formatDate(exp.data.endDate)}
                              </time>
                            </Fragment>
                          ) : (
                            ''
                          )}
                        </span>
                      </div>

                      {/* Organization with logo */}
                      <div class="flex items-center gap-4 mb-4">
                        {exp.data.logo && getLogoImage(exp.data.logo) ? (
                          exp.data.website ? (
                            <a
                              href={exp.data.website}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="flex-shrink-0 hover:opacity-80 transition-opacity"
                              aria-label={`Visiter le site de ${exp.data.organization} (nouvelle fen√™tre)`}
                            >
                              <Image
                                src={getLogoImage(exp.data.logo)!}
                                alt={exp.data.organization}
                                class="w-10 h-10 object-contain"
                                width={80}
                                height={80}
                                loading="lazy"
                                decoding="async"
                              />
                            </a>
                          ) : (
                            <Image
                              src={getLogoImage(exp.data.logo)!}
                              alt={exp.data.organization}
                              class="w-10 h-10 object-contain"
                              width={80}
                              height={80}
                              loading="lazy"
                              decoding="async"
                            />
                          )
                        ) : (
                          <div class="w-10 h-10 bg-dark-700 border border-dark-600 flex items-center justify-center flex-shrink-0">
                            <span class="text-sm font-heading font-bold text-accent-400">
                              {exp.data.organization.substring(0, 2).toUpperCase()}
                            </span>
                          </div>
                        )}
                        <div>
                          <p class="font-medium text-white text-sm">
                            {exp.data.website ? (
                              <a
                                href={exp.data.website}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="hover:text-accent-400 transition-colors"
                              >
                                {exp.data.organization}
                                <span class="sr-only"> (nouvelle fen√™tre)</span>
                              </a>
                            ) : (
                              exp.data.organization
                            )}
                          </p>
                          {exp.data.location && (
                            <p class="text-gray-400 text-xs">{exp.data.location}</p>
                          )}
                        </div>
                      </div>

                      {/* Title */}
                      <h3 class="font-heading font-bold text-xl text-white mb-3">
                        {exp.data.title}
                      </h3>

                      {/* Current indicator */}
                      {exp.data.current && (
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                          <span class="inline-flex items-center gap-2 text-xs text-accent-400 font-heading font-semibold">
                            <span class="w-2 h-2 bg-accent-400" />
                            En cours
                          </span>
                        </div>
                      )}

                      {/* Expandable details */}
                      <details class="mt-4 group">
                        <summary
                          class="cursor-pointer text-accent-400 text-sm font-heading font-semibold hover:text-accent-300 transition-colors flex items-center gap-2"
                          aria-label={`Voir les d√©tails de ${exp.data.title} √† ${exp.data.organization}`}
                        >
                          <span>Voir les d√©tails</span>
                          <svg
                            class="w-4 h-4 group-open:rotate-180 transition-transform"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </summary>
                        <div class="mt-4 pt-4 border-t border-dark-600">
                          <p class="text-gray-400 text-sm mb-4 leading-relaxed">
                            {exp.body || '[Description de la formation]'}
                          </p>

                          {(exp.data.relatedProjects?.length > 0 ||
                            exp.data.relatedSkills?.length > 0) && (
                            <div class="mt-4 pt-4 border-t border-dark-600">
                              <p class="text-xs text-gray-400 mb-2">Comp√©tences associ√©es :</p>
                              <div class="flex flex-wrap gap-2">
                                {exp.data.relatedSkills?.map((skillSlug: string) => (
                                  <a
                                    href={url(`/skills/${skillSlug}`)}
                                    class="text-xs text-accent-400 hover:underline"
                                  >
                                    ‚ö° {skillTitles.get(skillSlug) || skillSlug}
                                  </a>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </details>
                    </div>
                  </div>
                </div>
              );
            })
          }
        </div>
      </div>
    </div>
  </section>

  <!-- Work Experience Section -->
  <section class="section-padding section-lazy" aria-labelledby="work-heading">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto">
        <!-- Work Experience Header -->
        <div class="flex items-center gap-4 mb-12">
          <div class="icon-box-lg bg-primary-500 border-primary-500">
            <span class="text-2xl">üíº</span>
          </div>
          <h2 id="work-heading" class="text-2xl md:text-3xl font-heading font-bold text-white">
            Exp√©riences <span class="text-primary-400">Professionnelles</span>
          </h2>
        </div>

        <!-- Work Timeline -->
        <div class="relative">
          <!-- Vertical line -->
          <div
            class="absolute left-8 md:left-8 top-0 bottom-0 w-1 bg-gradient-to-b from-primary-500/30 to-primary-500 origin-top"
            data-gsap="timeline-line"
          >
          </div>

          <!-- Work Timeline items -->
          {
            workExperiences.map((exp) => {
              return (
                <div class="relative flex items-start mb-12 last:mb-0" data-gsap="timeline-item">
                  {/* Timeline dot */}
                  <div class="absolute left-8 transform -translate-x-1/2 z-10">
                    <div
                      class={`timeline-dot-lg ${exp.data.current ? 'bg-primary-500 border-primary-500 text-white' : 'bg-dark-800 border-primary-500'}`}
                    >
                      <span class="text-xl">üíº</span>
                    </div>
                  </div>

                  {/* Content card */}
                  <div class="ml-20 sm:ml-24 flex-1">
                    <div
                      class={`card-glow p-4 sm:p-6 md:p-8${!hasRealContent ? ' opacity-70' : ''}`}
                    >
                      {/* Date badge */}
                      <div class="flex mb-3">
                        <span class="tag-primary">
                          <time datetime={exp.data.startDate}>
                            {formatDate(exp.data.startDate)}
                          </time>
                          {exp.data.current ? (
                            ' - Pr√©sent'
                          ) : exp.data.endDate ? (
                            <Fragment>
                              {' '}
                              -{' '}
                              <time datetime={exp.data.endDate}>
                                {formatDate(exp.data.endDate)}
                              </time>
                            </Fragment>
                          ) : (
                            ''
                          )}
                        </span>
                      </div>

                      {/* Organization with logo */}
                      <div class="flex items-center gap-4 mb-4">
                        {exp.data.logo && getLogoImage(exp.data.logo) ? (
                          exp.data.website ? (
                            <a
                              href={exp.data.website}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="flex-shrink-0 hover:opacity-80 transition-opacity"
                              aria-label={`Visiter le site de ${exp.data.organization} (nouvelle fen√™tre)`}
                            >
                              <Image
                                src={getLogoImage(exp.data.logo)!}
                                alt={exp.data.organization}
                                class="w-10 h-10 object-contain"
                                width={80}
                                height={80}
                                loading="lazy"
                                decoding="async"
                              />
                            </a>
                          ) : (
                            <Image
                              src={getLogoImage(exp.data.logo)!}
                              alt={exp.data.organization}
                              class="w-10 h-10 object-contain"
                              width={80}
                              height={80}
                              loading="lazy"
                              decoding="async"
                            />
                          )
                        ) : (
                          <div class="w-10 h-10 bg-dark-700 border border-dark-600 flex items-center justify-center flex-shrink-0">
                            <span class="text-sm font-heading font-bold text-primary-400">
                              {exp.data.organization.substring(0, 2).toUpperCase()}
                            </span>
                          </div>
                        )}
                        <div>
                          <p class="font-medium text-white text-sm">
                            {!hasRealContent && '[PLACEHOLDER] '}
                            {exp.data.website ? (
                              <a
                                href={exp.data.website}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="hover:text-primary-400 transition-colors"
                              >
                                {exp.data.organization}
                                <span class="sr-only"> (nouvelle fen√™tre)</span>
                              </a>
                            ) : (
                              exp.data.organization
                            )}
                          </p>
                          {exp.data.location && (
                            <p class="text-gray-400 text-xs">{exp.data.location}</p>
                          )}
                        </div>
                      </div>

                      {/* Title */}
                      <h3 class="font-heading font-bold text-xl text-white mb-3">
                        {exp.data.title}
                      </h3>

                      {/* Status indicator */}
                      <div class="flex flex-wrap items-center gap-2 mb-3">
                        {exp.data.status && (
                          <span class="inline-flex items-center px-2 py-1 text-xs bg-primary-500/20 text-primary-400 font-heading font-semibold border border-primary-500/30">
                            {exp.data.status}
                          </span>
                        )}
                        {exp.data.current && (
                          <span class="inline-flex items-center gap-2 text-xs text-accent-400 font-heading font-semibold">
                            <span class="w-2 h-2 bg-accent-400" />
                            Poste actuel
                          </span>
                        )}
                      </div>

                      {/* Expandable details */}
                      <details class="mt-4 group">
                        <summary
                          class="cursor-pointer text-primary-400 text-sm font-heading font-semibold hover:text-primary-300 transition-colors flex items-center gap-2"
                          aria-label={`Voir les d√©tails de ${exp.data.title} chez ${exp.data.organization}`}
                        >
                          <span>Voir les d√©tails</span>
                          <svg
                            class="w-4 h-4 group-open:rotate-180 transition-transform"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </summary>
                        <div class="mt-4 pt-4 border-t border-dark-600">
                          <p class="text-gray-400 text-sm mb-4 leading-relaxed">
                            {exp.body || '[Description du poste, des missions et responsabilit√©s]'}
                          </p>

                          {exp.data.type === 'work' && exp.data.status && (
                            <div class="text-xs text-gray-400 mb-4">
                              <p>
                                ‚Ä¢ Statut :{' '}
                                <span class="text-primary-400 font-medium">{exp.data.status}</span>
                              </p>
                            </div>
                          )}

                          {(exp.data.relatedProjects?.length > 0 ||
                            exp.data.relatedSkills?.length > 0) && (
                            <div class="mt-4 pt-4 border-t border-dark-600">
                              <p class="text-xs text-gray-400 mb-2">Voir aussi :</p>
                              <div class="flex flex-wrap gap-2">
                                {exp.data.relatedProjects?.map((projectSlug: string) => (
                                  <a
                                    href={url(`/projects/${projectSlug}`)}
                                    class="text-xs text-primary-400 hover:underline"
                                  >
                                    üìÅ {projectTitles.get(projectSlug) || projectSlug}
                                  </a>
                                ))}
                                {exp.data.relatedSkills?.map((skillSlug: string) => (
                                  <a
                                    href={url(`/skills/${skillSlug}`)}
                                    class="text-xs text-accent-400 hover:underline"
                                  >
                                    ‚ö° {skillTitles.get(skillSlug) || skillSlug}
                                  </a>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </details>
                    </div>
                  </div>
                </div>
              );
            })
          }

          <!-- Future point -->
          <div class="relative flex items-start mt-12" data-gsap="reveal">
            <div class="absolute left-8 transform -translate-x-1/2">
              <div class="icon-box-lg bg-primary-500 border-primary-500">
                <span class="text-2xl">‚ú®</span>
              </div>
            </div>
            <div class="ml-20 sm:ml-24">
              <p class="text-gray-400 text-sm font-heading italic">La suite s'√©crit...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="section-padding section-cta relative overflow-hidden section-lazy">
    <div class="container-custom text-center" data-gsap="cta">
      <h2 class="section-title text-white mb-8">
        √âcrivons la suite <span class="text-accent-400 squiggle squiggle-accent">ensemble</span>
      </h2>
      <p class="text-gray-300 text-xl mb-12 max-w-2xl mx-auto leading-relaxed">
        L'histoire n'est pas finie. Si vous pensez qu'on pourrait bosser ensemble, faites-moi signe.
      </p>
      <div class="flex flex-wrap justify-center gap-8">
        <a
          href={url('/contact')}
          class="btn-chunky bg-white text-dark-900 border-dark-900 hover:bg-gray-100"
        >
          Me contacter
        </a>
        <a
          href={url('/projects')}
          class="btn-chunky bg-transparent text-white border-white hover:bg-white hover:text-dark-900"
        >
          Voir mes r√©alisations
        </a>
      </div>
    </div>
  </section>
</BaseLayout>
