---
import { slide } from 'astro:transitions';
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { url } from '@utils/url';

export async function getStaticPaths() {
  const skills = await getCollection('skills');
  return skills.map((skill) => ({
    params: { slug: skill.id },
    props: { skill },
  }));
}

const { skill } = Astro.props;

// Parse markdown content into sections
const rawContent = skill.body;

function extractSection(content: string, sectionName: string): string {
  const regex = new RegExp(`## ${sectionName}[\\s\\S]*?(?=\\n## |$)`, 'i');
  const match = content.match(regex);
  if (!match) return '';
  return match[0].replace(new RegExp(`## ${sectionName}[^\\n]*\\n?`, 'i'), '').trim();
}

// Extract all sections
const definitionContent = extractSection(rawContent, 'Ma D√©finition');
const preuvesContent = extractSection(rawContent, 'Mes √©l√©ments de preuve');
const autocritiqueContent = extractSection(rawContent, 'Mon autocritique');
const evolutionContent = extractSection(rawContent, 'Mon √©volution dans cette comp√©tence');

// Get related projects
const allProjects = await getCollection('projects');
const relatedProjects = allProjects.filter((p) => skill.data.relatedProjects.includes(p.id));

// Get all skills for navigation
const allSkills = await getCollection('skills');
const sortedSkills = allSkills.sort((a, b) => a.data.order - b.data.order);
const currentIndex = sortedSkills.findIndex((s) => s.id === skill.id);
const prevSkill = currentIndex > 0 ? sortedSkills[currentIndex - 1] : null;
const nextSkill = currentIndex < sortedSkills.length - 1 ? sortedSkills[currentIndex + 1] : null;

const isTechnical = skill.data.category === 'technical';
---

<BaseLayout
  title={skill.data.title}
  description={`${skill.data.title} : ce que j'en fais, comment je la pratique, et mon regard critique.`}
>
  <!-- BreadcrumbList Schema -->
  <Fragment slot="head">
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'BreadcrumbList',
        itemListElement: [
          {
            '@type': 'ListItem',
            position: 1,
            name: 'Accueil',
            item: 'https://leigh-chr.github.io/',
          },
          {
            '@type': 'ListItem',
            position: 2,
            name: 'Comp√©tences',
            item: 'https://leigh-chr.github.io/skills/',
          },
          {
            '@type': 'ListItem',
            position: 3,
            name: skill.data.title,
            item: `https://leigh-chr.github.io/skills/${skill.id}/`,
          },
        ],
      })}
    />
  </Fragment>

  <!-- Hero Section -->
  <section class="section-padding section-hero">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto" data-gsap="reveal">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-gray-400 mb-6" aria-label="Fil d'Ariane">
          <ol role="list" class="flex items-center gap-2">
            <li>
              <a href={url('/')} class="hover:text-primary-400 transition-colors">Accueil</a>
            </li>
            <li class="flex items-center gap-2">
              <span aria-hidden="true">/</span>
              <a href={url('/skills')} class="hover:text-primary-400 transition-colors"
                >Comp√©tences</a
              >
            </li>
            <li class="flex items-center gap-2">
              <span aria-hidden="true">/</span>
              <span class="text-white" aria-current="page">{skill.data.title}</span>
            </li>
          </ol>
        </nav>

        <!-- Header -->
        <div class="flex flex-col sm:flex-row items-start gap-4 sm:gap-6 md:gap-8">
          <div
            class="profile-avatar-xl flex items-center justify-center flex-shrink-0"
            transition:name={`skill-icon-${skill.id}`}
          >
            <span class="text-3xl sm:text-4xl"
              >{skill.data.icon || (isTechnical ? 'üíª' : 'ü§ù')}</span
            >
          </div>
          <div>
            <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
              <span class={isTechnical ? 'tag-primary' : 'tag-accent'}>
                {isTechnical ? 'Technique' : 'Humaine'}
              </span>
              <span class="tag-gray" transition:name={`skill-level-${skill.id}`}
                >{`${skill.data.level}/10`}</span
              >
            </div>
            <h1
              class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-heading font-black text-white mb-4 tracking-tight"
              transition:name={`skill-title-${skill.id}`}
            >
              <span class="underline-memphis">{skill.data.title}</span>
            </h1>
            <p class="text-lg sm:text-xl text-gray-400">
              {skill.data.summary}
            </p>
          </div>
        </div>

        <!-- Level indicator - Bold Memphis -->
        <div class="mt-6 sm:mt-8 detail-box border-3 border-dark-600">
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-4 mb-4"
          >
            <span
              class="text-base sm:text-xl font-heading font-bold text-gray-300 uppercase tracking-wide"
              >Niveau de ma√Ætrise</span
            >
            <span class="text-2xl sm:text-3xl font-heading font-black text-primary-400">
              {`${skill.data.level}/10`}
            </span>
          </div>
          <div class="skill-level-animated h-4">
            <div class="skill-fill" style={`width: ${skill.data.level * 10}%`}></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Content Sections -->
  <section>
    <div class="container-custom" transition:animate={slide({ duration: '0.3s' })}>
      <div class="max-w-4xl mx-auto">
        <!-- Section 1: Ma D√©finition -->
        {
          definitionContent && (
            <section class="mb-20" id="definition">
              <div class="content-section-header">
                <div class="icon-box-sm">
                  <span class="text-xl">üìñ</span>
                </div>
                <h2 class="content-section-title">
                  Ma <span class="text-primary-400 underline-memphis">D√©finition</span>
                </h2>
              </div>
              <div class="section-divider ml-0 mx-0 mb-8" />
              <div class="prose prose-lg prose-invert max-w-none text-gray-400 detail-box">
                <div
                  set:html={definitionContent
                    .replace(/\n\n/g, '</p><p>')
                    .replace(
                      /\*\*\[([^\]]+)\]\(([^)]+)\)\*\*/g,
                      '<a href="$2" class="text-primary-400 hover:underline font-semibold">$1</a>'
                    )
                    .replace(
                      /\[([^\]]+)\]\(([^)]+)\)/g,
                      '<a href="$2" class="text-primary-400 hover:underline">$1</a>'
                    )
                    .replace(/\*\*([^*]+)\*\*/g, '<strong class="text-white">$1</strong>')
                    .replace(/^(.+)$/gm, '<p>$1</p>')
                    .replace(/<p><\/p>/g, '')}
                />
              </div>
            </section>
          )
        }

        <!-- Section 2: Mes √âl√©ments de Preuve -->
        {
          preuvesContent && (
            <section class="mb-20" id="preuves">
              <div class="content-section-header">
                <div class="icon-box-sm">
                  <span class="text-xl">üéØ</span>
                </div>
                <h2 class="content-section-title">
                  Mes √âl√©ments de{' '}
                  <span class="text-accent-400 underline-memphis underline-memphis-accent">
                    Preuve
                  </span>
                </h2>
              </div>
              <div class="section-divider section-divider-accent ml-0 mx-0 mb-8" />
              <div class="prose prose-lg prose-invert max-w-none text-gray-400 detail-box">
                <div
                  set:html={preuvesContent
                    .replace(
                      /### ([^\n]+)/g,
                      '<h3 class="text-xl font-heading font-bold text-white mt-8 mb-4">$1</h3>'
                    )
                    .replace(/\n\n/g, '</p><p>')
                    .replace(
                      /\*\*\[([^\]]+)\]\(([^)]+)\)\*\*/g,
                      '<a href="$2" class="text-primary-400 hover:underline font-semibold">$1</a>'
                    )
                    .replace(
                      /\[([^\]]+)\]\(([^)]+)\)/g,
                      '<a href="$2" class="text-primary-400 hover:underline">$1</a>'
                    )
                    .replace(/\*\*([^*]+)\*\*/g, '<strong class="text-white">$1</strong>')
                    .replace(/^(?!<[hp])(.*[^>])$/gm, '<p>$1</p>')
                    .replace(/<p><\/p>/g, '')
                    .replace(/<p><h3/g, '<h3')
                    .replace(/<\/h3><\/p>/g, '</h3>')}
                />
              </div>
            </section>
          )
        }

        <!-- Section 3: Mon Autocritique -->
        {
          autocritiqueContent && (
            <section class="mb-20" id="autocritique">
              <div class="content-section-header">
                <div class="icon-box-sm">
                  <span class="text-xl">üîç</span>
                </div>
                <h2 class="content-section-title">
                  Mon <span class="text-primary-400 underline-memphis">Autocritique</span>
                </h2>
              </div>
              <div class="section-divider ml-0 mx-0 mb-8" />
              <div class="prose prose-lg prose-invert max-w-none text-gray-400 detail-box">
                <div
                  set:html={autocritiqueContent
                    .replace(/\n\n/g, '</p><p>')
                    .replace(
                      /\*\*\[([^\]]+)\]\(([^)]+)\)\*\*/g,
                      '<a href="$2" class="text-primary-400 hover:underline font-semibold">$1</a>'
                    )
                    .replace(
                      /\[([^\]]+)\]\(([^)]+)\)/g,
                      '<a href="$2" class="text-primary-400 hover:underline">$1</a>'
                    )
                    .replace(/\*\*([^*]+)\*\*/g, '<strong class="text-white">$1</strong>')
                    .replace(/^(.+)$/gm, '<p>$1</p>')
                    .replace(/<p><\/p>/g, '')}
                />
              </div>
            </section>
          )
        }

        <!-- Section 4: Mon √âvolution -->
        {
          evolutionContent && (
            <section class="mb-20" id="evolution">
              <div class="content-section-header">
                <div class="icon-box-sm">
                  <span class="text-xl">üìà</span>
                </div>
                <h2 class="content-section-title">
                  Mon{' '}
                  <span class="text-accent-400 underline-memphis underline-memphis-accent">
                    √âvolution
                  </span>
                </h2>
              </div>
              <div class="section-divider section-divider-accent ml-0 mx-0 mb-8" />
              <div class="prose prose-lg prose-invert max-w-none text-gray-400 detail-box">
                <div
                  set:html={evolutionContent
                    .replace(/\n\n/g, '</p><p>')
                    .replace(
                      /\*\*\[([^\]]+)\]\(([^)]+)\)\*\*/g,
                      '<a href="$2" class="text-primary-400 hover:underline font-semibold">$1</a>'
                    )
                    .replace(
                      /\[([^\]]+)\]\(([^)]+)\)/g,
                      '<a href="$2" class="text-primary-400 hover:underline">$1</a>'
                    )
                    .replace(/\*\*([^*]+)\*\*/g, '<strong class="text-white">$1</strong>')
                    .replace(/^(.+)$/gm, '<p>$1</p>')
                    .replace(/<p><\/p>/g, '')}
                />
              </div>
            </section>
          )
        }

        <!-- Section 5: R√©alisations Associ√©es -->
        <section class="mb-20" id="realisations">
          <div class="content-section-header">
            <div class="icon-box-sm">
              <span class="text-xl">üîó</span>
            </div>
            <h2 class="content-section-title">
              R√©alisations <span class="text-accent-400 underline-memphis underline-memphis-accent"
                >Associ√©es</span
              >
            </h2>
          </div>
          <div class="section-divider section-divider-accent ml-0 mx-0 mb-8"></div>

          {
            relatedProjects.length > 0 ? (
              <div class="grid md:grid-cols-2 gap-4 sm:gap-6 md:gap-8" data-gsap="stagger">
                {relatedProjects.map((project) => (
                  <a
                    href={url(`/projects/${project.id}`)}
                    class="card-glow p-4 sm:p-6 md:p-8 group"
                  >
                    <h3 class="font-heading font-bold text-xl text-white mb-3 group-hover:text-primary-400 transition-colors">
                      {project.data.title}
                    </h3>
                    <p class="text-gray-400 text-sm line-clamp-2 mb-6">
                      {project.data.shortDescription}
                    </p>
                    <div class="flex items-center text-primary-400 text-sm font-heading font-medium">
                      <span>Voir la r√©alisation</span>
                      <svg
                        class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 5l7 7-7 7"
                        />
                      </svg>
                    </div>
                  </a>
                ))}
              </div>
            ) : (
              <p class="text-gray-400 detail-box">Aucune r√©alisation associ√©e pour le moment.</p>
            )
          }
        </section>

        <!-- Navigation between skills -->
        <nav
          class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-10 border-t border-dark-600"
          aria-label="Navigation entre comp√©tences"
        >
          {
            prevSkill ? (
              <a
                href={url(`/skills/${prevSkill.id}`)}
                class="flex items-center gap-2 text-gray-400 hover:text-primary-400 transition-colors order-2 sm:order-1"
                aria-label={`Comp√©tence pr√©c√©dente : ${prevSkill.data.title}`}
              >
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
                <span class="text-sm line-clamp-1 max-w-[120px] sm:max-w-[150px]">
                  {prevSkill.data.title}
                </span>
              </a>
            ) : (
              <span class="order-2 sm:order-1" />
            )
          }

          <a
            href={url('/skills')}
            class="text-sm text-gray-400 hover:text-primary-400 transition-colors order-1 sm:order-2"
          >
            Toutes les comp√©tences
          </a>

          {
            nextSkill ? (
              <a
                href={url(`/skills/${nextSkill.id}`)}
                class="flex items-center gap-2 text-gray-400 hover:text-primary-400 transition-colors order-3"
                aria-label={`Comp√©tence suivante : ${nextSkill.data.title}`}
              >
                <span class="text-sm line-clamp-1 max-w-[120px] sm:max-w-[150px]">
                  {nextSkill.data.title}
                </span>
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            ) : (
              <span class="order-3" />
            )
          }
        </nav>
      </div>
    </div>
  </section>
</BaseLayout>
