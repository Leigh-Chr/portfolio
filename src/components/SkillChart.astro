---
import type { SkillGroup } from '@utils/skills';
import { url } from '@utils/url';

interface Skill {
  name: string;
  slug: string;
  level: number;
  category: 'technical' | 'human';
  group: SkillGroup;
}

interface Props {
  skills: Skill[];
}

// SVG Chart constants
const SVG_SIZE = 520;
const SVG_CENTER = 260;
const MAX_RADIUS = 160;
const LABEL_RADIUS = 185;
const RING_COUNT = 5;
const RING_SPACING = 32;

const { skills } = Astro.props;

// Group skills by group
const frontendSkills = skills.filter((s) => s.group === 'frontend');
const backendSkills = skills.filter((s) => s.group === 'backend');
const personalSkills = skills.filter((s) => s.group === 'personal');
const interpersonalSkills = skills.filter((s) => s.group === 'interpersonal');

// Color mapping for groups
interface GroupColorConfig {
  fill: string;
  text: string;
  bg: string;
}

// Color mapping for groups - using design system colors
const groupColors: Record<SkillGroup, GroupColorConfig> = {
  frontend: { fill: '#22d3ee', text: 'text-info-400', bg: 'bg-info-500' },
  backend: { fill: '#a855f7', text: 'text-primary-400', bg: 'bg-primary-500' },
  personal: { fill: '#facc15', text: 'text-accent-400', bg: 'bg-accent-500' },
  interpersonal: { fill: '#fb7185', text: 'text-tertiary-400', bg: 'bg-tertiary-500' },
};

// Helper function to safely calculate average
function calculateAverage(skillsArray: Skill[]): number {
  if (skillsArray.length === 0) return 0;
  return Math.round(skillsArray.reduce((sum, s) => sum + s.level, 0) / skillsArray.length);
}

// Order skills by group for better visual in radar
const orderedSkills = [
  ...frontendSkills,
  ...backendSkills,
  ...personalSkills,
  ...interpersonalSkills,
];
---

<!-- Radar Chart Visual Representation -->
<div class="relative w-full max-w-2xl mx-auto">
  <!-- SVG Radar Chart with padding for labels -->
  <svg
    viewBox={`0 0 ${SVG_SIZE} ${SVG_SIZE}`}
    class="w-full h-auto"
    role="group"
    aria-label="Graphique radar repr√©sentant les niveaux de comp√©tences par domaine : Frontend, Backend, Personnelles et Interpersonnelles"
  >
    <!-- Background circles -->
    {
      Array.from({ length: RING_COUNT }, (_, i) => i + 1).map((ring) => (
        <circle
          cx={SVG_CENTER}
          cy={SVG_CENTER}
          r={ring * RING_SPACING}
          fill="none"
          stroke="#3d3d3d"
          stroke-width="1"
          class="opacity-50"
        />
      ))
    }

    <!-- Axis lines with group colors -->
    {
      orderedSkills.map((skill, index) => {
        const angle = (((index * 360) / orderedSkills.length - 90) * Math.PI) / 180;
        const x = SVG_CENTER + MAX_RADIUS * Math.cos(angle);
        const y = SVG_CENTER + MAX_RADIUS * Math.sin(angle);
        return (
          <line
            x1={SVG_CENTER}
            y1={SVG_CENTER}
            x2={x}
            y2={y}
            stroke={groupColors[skill.group].fill}
            stroke-width="1"
            class="opacity-30"
          />
        );
      })
    }

    <!-- Data polygon -->
    <polygon
      points={orderedSkills
        .map((skill, index) => {
          const angle = (((index * 360) / orderedSkills.length - 90) * Math.PI) / 180;
          const radius = (skill.level / 10) * MAX_RADIUS;
          const x = SVG_CENTER + radius * Math.cos(angle);
          const y = SVG_CENTER + radius * Math.sin(angle);
          return `${x},${y}`;
        })
        .join(' ')}
      fill="url(#skillGradient4)"
      fill-opacity="0.25"
      stroke="url(#skillGradient4)"
      stroke-width="2"></polygon>

    <!-- Data points with group colors -->
    {
      orderedSkills.map((skill, index) => {
        const angle = (((index * 360) / orderedSkills.length - 90) * Math.PI) / 180;
        const radius = (skill.level / 10) * MAX_RADIUS;
        const x = SVG_CENTER + radius * Math.cos(angle);
        const y = SVG_CENTER + radius * Math.sin(angle);
        return (
          <a
            href={url(`/skills/${skill.slug}`)}
            aria-label={`${skill.name} - niveau ${skill.level}/10`}
          >
            <circle
              cx={x}
              cy={y}
              r="6"
              fill={groupColors[skill.group].fill}
              stroke="#0a0a0a"
              stroke-width="2"
              class="skill-point"
              data-skill={skill.name}
              data-level={skill.level}
            />
          </a>
        );
      })
    }

    <!-- Labels with group colors -->
    {
      orderedSkills.map((skill, index) => {
        const angle = (((index * 360) / orderedSkills.length - 90) * Math.PI) / 180;
        const x = SVG_CENTER + LABEL_RADIUS * Math.cos(angle);
        const y = SVG_CENTER + LABEL_RADIUS * Math.sin(angle);
        const textAnchor = x < SVG_CENTER - 30 ? 'end' : x > SVG_CENTER + 30 ? 'start' : 'middle';
        return (
          <a
            href={url(`/skills/${skill.slug}`)}
            class="skill-label-link"
            aria-label={`Voir la comp√©tence ${skill.name}`}
          >
            <text
              x={x}
              y={y}
              text-anchor={textAnchor}
              dominant-baseline="middle"
              fill={groupColors[skill.group].fill}
              class="font-heading skill-label"
              style="font-size: 11px; font-weight: 600;"
            >
              {skill.name}
            </text>
          </a>
        );
      })
    }

    <!-- Gradient definition with 4 colors -->
    <defs>
      <linearGradient id="skillGradient4" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#22d3ee"></stop>
        <stop offset="33%" stop-color="#a855f7"></stop>
        <stop offset="66%" stop-color="#facc15"></stop>
        <stop offset="100%" stop-color="#fb7185"></stop>
      </linearGradient>
    </defs>
  </svg>

  <!-- Legend with 4 groups -->
  <div class="grid grid-cols-2 gap-3 sm:gap-4 mt-6 sm:mt-8 max-w-lg mx-auto px-4 sm:px-0">
    <div class="flex items-center gap-2">
      <span class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-info-400 rounded-sm flex-shrink-0"></span>
      <span class="text-[10px] sm:text-xs text-gray-300">Frontend ({frontendSkills.length})</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-primary-500 rounded-sm flex-shrink-0"></span>
      <span class="text-[10px] sm:text-xs text-gray-300">Backend ({backendSkills.length})</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-accent-400 rounded-sm flex-shrink-0"></span>
      <span class="text-[10px] sm:text-xs text-gray-300">Perso. ({personalSkills.length})</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-tertiary-400 rounded-sm flex-shrink-0"></span>
      <span class="text-[10px] sm:text-xs text-gray-300"
        >Interperso. ({interpersonalSkills.length})</span
      >
    </div>
  </div>
</div>

<!-- Bar Chart by Groups -->
<div class="mt-10 sm:mt-16 grid md:grid-cols-2 gap-4 sm:gap-6 md:gap-8">
  <!-- Frontend Skills -->
  <div
    class="p-4 sm:p-6 bg-dark-800 border-2 border-dark-600 hover:border-info-500/50 transition-colors"
  >
    <h3 class="font-heading font-bold text-base text-white mb-6 flex items-center gap-2">
      <span class="w-3 h-3 bg-info-400"></span>
      üé® D√©veloppement Frontend
      <span class="ml-auto text-xs text-info-400 font-normal"
        >Moy. {calculateAverage(frontendSkills)}/10</span
      >
    </h3>
    <div class="space-y-4">
      {
        frontendSkills.map((skill) => (
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium text-gray-200">{skill.name}</span>
              <span class="text-xs text-info-400 font-heading font-semibold">{skill.level}/10</span>
            </div>
            <div class="skill-level">
              <div class="h-full bg-info-400" style={`width: ${skill.level * 10}%`} />
            </div>
          </div>
        ))
      }
    </div>
  </div>

  <!-- Backend Skills -->
  <div
    class="p-4 sm:p-6 bg-dark-800 border-2 border-dark-600 hover:border-primary-500/50 transition-colors"
  >
    <h3 class="font-heading font-bold text-base text-white mb-6 flex items-center gap-2">
      <span class="w-3 h-3 bg-primary-500"></span>
      ‚öôÔ∏è D√©veloppement Backend
      <span class="ml-auto text-xs text-primary-400 font-normal"
        >Moy. {calculateAverage(backendSkills)}/10</span
      >
    </h3>
    <div class="space-y-4">
      {
        backendSkills.map((skill) => (
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium text-gray-200">{skill.name}</span>
              <span class="text-xs text-primary-400 font-heading font-semibold">
                {skill.level}/10
              </span>
            </div>
            <div class="skill-level">
              <div class="h-full bg-primary-500" style={`width: ${skill.level * 10}%`} />
            </div>
          </div>
        ))
      }
    </div>
  </div>

  <!-- Personal Skills -->
  <div
    class="p-4 sm:p-6 bg-dark-800 border-2 border-dark-600 hover:border-accent-500/50 transition-colors"
  >
    <h3 class="font-heading font-bold text-base text-white mb-6 flex items-center gap-2">
      <span class="w-3 h-3 bg-accent-400"></span>
      üß† Comp√©tences Personnelles
      <span class="ml-auto text-xs text-accent-400 font-normal"
        >Moy. {calculateAverage(personalSkills)}/10</span
      >
    </h3>
    <div class="space-y-4">
      {
        personalSkills.map((skill) => (
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium text-gray-200">{skill.name}</span>
              <span class="text-xs text-accent-400 font-heading font-semibold">
                {skill.level}/10
              </span>
            </div>
            <div class="skill-level">
              <div class="h-full bg-accent-400" style={`width: ${skill.level * 10}%`} />
            </div>
          </div>
        ))
      }
    </div>
  </div>

  <!-- Interpersonal Skills -->
  <div
    class="p-4 sm:p-6 bg-dark-800 border-2 border-dark-600 hover:border-tertiary-500/50 transition-colors"
  >
    <h3 class="font-heading font-bold text-base text-white mb-6 flex items-center gap-2">
      <span class="w-3 h-3 bg-tertiary-400"></span>
      ü§ù Comp√©tences Interpersonnelles
      <span class="ml-auto text-xs text-tertiary-400 font-normal"
        >Moy. {calculateAverage(interpersonalSkills)}/10</span
      >
    </h3>
    <div class="space-y-4">
      {
        interpersonalSkills.map((skill) => (
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium text-gray-200">{skill.name}</span>
              <span class="text-xs text-tertiary-400 font-heading font-semibold">
                {skill.level}/10
              </span>
            </div>
            <div class="skill-level">
              <div class="h-full bg-tertiary-400" style={`width: ${skill.level * 10}%`} />
            </div>
          </div>
        ))
      }
    </div>
  </div>
</div>

<style>
  .skill-point {
    transition: r 0.2s ease;
    cursor: pointer;
  }
  .skill-point:hover {
    r: 10;
  }
  .skill-label {
    transition: opacity 0.2s ease;
    cursor: pointer;
  }
  .skill-label-link:hover .skill-label {
    opacity: 0.7;
  }
</style>
